# X 关注列表提取器 - 开发对话总结

## 1. 初始需求

> 能看到我当前浏览器开的页面么

我确认了用户当前有一个空白页打开。

---

> 再打开一个吧

打开了 x.com 页面。

---

## 2. 插件开发需求

> 帮我写个浏览器插件，当我打开 x.com 某个人的关注列表，可以一键获取他的关注人列表，包括头像、姓名、主页链接，保存为一个json文件，例如这个 https://x.com/liangxiaowei18/following 网址就是一个关注列表

创建了一个 Chrome 浏览器插件，包含以下文件：
- `manifest.json` - 插件配置
- `content.js` - 页面脚本，提取数据
- `popup.html` / `popup.js` - 弹窗界面
- 图标文件

---

## 3. 图标问题

> 提示图标加载不了，还是用python帮我糊一个吧

用 Python + Pillow 创建了图标文件。

---

## 4. Bug 修复 - TypeError

> Error in event handler: TypeError: extractFollowingList(...).then is not a function

修复：`extractFollowingList` 是同步函数，不能调用 `.then()`。改用 async/await 包裹。

---

## 5. 头像为空问题

> avatar图片是空的，你有什么其他方法？

> 你可以直接找img标签

修改选择器，直接查找 `img` 标签而不是带 `alt` 属性的选择器。

---

## 6. 自动滚动问题

> 为什么不会自动滚动？只是下载了一页数据

问题：只有当 `users.length === 0` 时才会滚动。修复为先滚动加载所有数据，再提取。

---

## 7. 只获取最后一页数据

> 还是没有哦

问题：虚拟滚动导致只保留最后加载的元素。改为边滚动边收集数据。

---

## 8. HTML 查看器需求

> 把这个拿下来的关注列表变成一个静态网址，可以显示头像、用户名、点击可以跳转

> 不用很复杂，用一个简单的列表就行，从左到右排列

创建 `following-viewer.html`，支持导入 JSON 文件显示网格布局。

---

## 9. 需求变更

> 需求改成用户支持导入关注列表 json 文件

修改 HTML 为文件导入模式。

---

## 10. 头像为空问题

> 我发现拿下来的 json 数据有些头像是空的，为什么？

分析可能是懒加载问题。

---

## 11. 重试机制

> 最后加一个重试机制，把avatar为空的再拿一次

添加了重试机制，滚动完成后回到顶部重新扫描。

---

## 12. 去掉重试，尝试 data-src

> 还是不行，先去掉这个机制吧，是不是因为图片加载需要时间，你试试data-src

去掉重试，改为优先尝试 `data-src` 属性。

---

## 13. 图片加载等待机制

> 如果是因为懒加载能不能，滑动一页，等一会，让图片都显示完成，然后再获取？这样是可以接受的，整个过程不需要太快

改为滚动一页后等待图片加载完成再获取。

---

## 14. 还是不行

> 还是不行

---

## 15. 改为每滚动一次获取一次

> 改成每滚动一次，就获取一次，最后再整合在一起，记得去重，还有保存成功后，如果有头像为空，给我提示出来

修改为：
- 每滚动一次获取一次数据
- 用 Set 去重
- 最后统计并提示头像为空的用户

---

## 16. 时间间隔改为 10 秒

> 每次滚动之间的时间间隔改成10秒

每次滚动间隔改为 10 秒。

---

## 17. 等待头像加载完成

> 改成每次滚动后，设置一个循环，看一下头像是否都有，如果不是，则等待1秒，如果都有，收集完数据，就可以下一次滚动

修改逻辑：
1. 滚动到底部
2. 等待 1 秒
3. 循环检查头像（最多 60 秒）
4. 所有头像都有了才收集数据
5. 继续下一次滚动

---

## 最终实现

### 文件结构

```
x-follow-extractor/
├── manifest.json          # 插件配置
├── content.js             # 页面脚本（滚动+提取逻辑）
├── popup.html             # 弹窗界面
├── popup.js               # 弹窗逻辑
├── icon16.png            # 16x16 图标
├── icon48.png            # 48x48 图标
├── icon128.png           # 128x128 图标
├── following-viewer.html  # JSON 查看器
└── 对话总结.md           # 本文件
```

### 主要功能

1. **Chrome 插件**
   - 打开 X 关注列表页（如 `x.com/xxx/following`）
   - 点击插件图标
   - 自动滚动到底部
   - 每滚动后检查头像是否加载完成
   - 收集所有用户数据（头像、用户名、显示名、主页链接）
   - 下载为 JSON 文件

2. **HTML 查看器**
   - 导入 JSON 文件
   - 显示网格布局的用户卡片
   - 点击跳转到主页

### 提取逻辑

```javascript
每次滚动：
1. 滚动到底部
2. 等待 1 秒
3. 循环检查头像（最多 60 秒）：
   - 检查 `data-src` 或 `src` 属性
   - 如果都有，开始收集
   - 如果没有，等待 1 秒后重试
4. 收集当前所有用户
5. 用 Set 去重
6. 检查 DOM 数量，连续 5 次不变则完成

完成后：
- 统计头像为空的用户
- 在 Console 输出警告列表
